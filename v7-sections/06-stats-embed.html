<script>
window.AV=window.AV||{};
window.AV.stats=function(){
var statsSection=document.querySelector('.stats');
if(!statsSection)return;

var hasFlipped=false;

ScrollTrigger.create({
trigger:statsSection,
start:'top 70%',
onEnter:function(){
if(hasFlipped)return;
hasFlipped=true;
animateAll();
}
});

function animateAll(){
var statItems=document.querySelectorAll('[data-animate="flip-clock"]');

statItems.forEach(function(item,itemIdx){
var cards=item.querySelectorAll('.flip-card');
var suffix=item.querySelector('.stat-suffix');
var separator=item.querySelector('.stat-separator');

cards.forEach(function(card,cardIdx){
var targetDigit=parseInt(card.getAttribute('data-digit'));
var topSpan=card.querySelector('.flip-card-top span');
var bottomSpan=card.querySelector('.flip-card-bottom span');
var delay=(itemIdx*0.5)+(cardIdx*0.2);
animateDigit(card,topSpan,bottomSpan,targetDigit,delay);
});

var suffixDelay=(itemIdx*0.5)+(cards.length*0.2)+1.6;
if(suffix)gsap.to(suffix,{opacity:1,duration:0.4,delay:suffixDelay,ease:'power2.out'});
if(separator)gsap.to(separator,{opacity:1,duration:0.4,delay:(itemIdx*0.5)+0.4,ease:'power2.out'});

var label=item.querySelector('[data-animate="scramble"]');
if(label)scrambleDecode(label,suffixDelay+0.2);
});
}

function animateDigit(card,topSpan,bottomSpan,target,delay){
var inner=card.querySelector('.flip-card-inner');
var flipDuration=0.3;
var steps=[];
if(target===0){steps.push(8,4,0)}
else if(target<=3){for(var i=1;i<=target;i++)steps.push(i)}
else{var step=Math.max(1,Math.floor(target/3));for(var v=step;v<target;v+=step)steps.push(v);if(steps[steps.length-1]!==target)steps.push(target)}

var currentDigit=0;
var stepIndex=0;

function doNextFlip(){
if(stepIndex>=steps.length)return;
var newDigit=steps[stepIndex];
topSpan.textContent=newDigit;

var overlay=document.createElement('div');
overlay.className='flip-card-flip-top';
overlay.innerHTML='<span>'+currentDigit+'</span>';
overlay.style.cssText='position:absolute;top:0;left:0;width:100%;height:50%;overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:2px;font-size:48px;color:#f0ede8;background:#1a1a1a;border-radius:6px 6px 0 0;transform-origin:bottom center;z-index:4;';
inner.appendChild(overlay);

gsap.set(overlay,{rotateX:0,transformPerspective:400});
gsap.to(overlay,{
rotateX:-90,
duration:flipDuration,
ease:'power2.in',
onComplete:function(){
overlay.remove();
bottomSpan.textContent=newDigit;
currentDigit=newDigit;
stepIndex++;
doNextFlip();
}
});
}

gsap.delayedCall(delay,doNextFlip);
}

function scrambleDecode(el,delay){
var originalText=el.textContent;
var chars='\u2588\u2593\u2591\u2592ABCDEFGHIJKLMNOPQRSTUVWXYZ';
var frame=0;
var totalFrames=30;

setTimeout(function(){
var interval=setInterval(function(){
frame++;
var decoded='';
for(var i=0;i<originalText.length;i++){
if(originalText[i]===' ')decoded+=' ';
else if(i<(frame/totalFrames)*originalText.length)decoded+=originalText[i];
else decoded+=chars[Math.floor(Math.random()*chars.length)];
}
el.textContent=decoded;
if(frame>=totalFrames){clearInterval(interval);el.textContent=originalText}
},50);
},delay*1000);
}
};
</script>
